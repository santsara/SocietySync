<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SocietySync - Society Connect</title>
    <style>
        /* Banner */ 
        .banner
        { 
            background-color: #4d2822; 
            color: #FFF9EE; 
            padding: 20px; 
            text-align: center; 
            position: relative; 
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 50px;
        } 

        .banner-icon
        { 
            position: absolute; 
            left: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 75px; 
            height: 75px; 
        }
         
        .banner-title
        { 
            font-size: 28px; 
            font-weight: bold; 
        }
         
        body
        {
            background: linear-gradient(135deg, #FFF0D3, #FFF9EE);
            font-family: 'Segoe UI', sans-serif;
            margin: 0px;
            padding: 0px;
            padding-bottom: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
         
        header 
        {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }
         
        section.contacts
        {
            max-width: 800px;
            width: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 0 20px;
        }
         
        .contact-group
        {
            background-color: #FFF9EE;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .contact-group h2
        {
            color: #4d2822;
            margin-bottom: 5px;
        }
        .contact-group h3 {
             color: #8b3a3a;
             margin-top: 15px;
             margin-bottom: 5px;
        }

        .contact-group ul
        {
            list-style: none;
            padding: 0;
            margin-bottom: 0;
            color: #444;
        }

        /* ------------------------------------------- */
        /* KEY FIX: Uniform Spacing with Flexbox */
        /* ------------------------------------------- */
        .contact-list-item
        {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            display: flex; /* Use flexbox for horizontal alignment */
            align-items: center;
            justify-content: space-between;
            gap: 10px; /* Space between elements */
        }
        .contact-list-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        /* Role text takes up available space */
        .contact-role-text {
            flex-grow: 1; 
            white-space: nowrap; /* Prevent wrapping for simple alignment */
            overflow: hidden;
            text-overflow: ellipsis; /* Handle long roles gracefully */
        }

        /* Contact number maintains a consistent width for column alignment */
        .contact-number {
             min-width: 150px; /* Ensure numbers line up consistently */
             text-align: right;
             font-weight: bold;
             color: #4d2822; /* Use theme color for emphasis */
             flex-shrink: 0; /* Prevents number from shrinking */
        }

        .contact-list-item strong
        {
            font-weight: 600;
        }
        /* ------------------------------------------- */
        
        /* Committee Form Styles */
        #contactFormContainer {
            display: none; 
            margin-bottom: 40px;
            max-width: 800px;
            width: 100%;
            padding: 0 20px;
        }
        #contactEditForm {
            background: #fff9ee;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #contactEditForm h3 {
            margin-bottom: 20px;
            color: #4d2822;
        }
        #contactEditForm label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        #contactEditForm input[type="text"], #contactEditForm input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        /* PRIMARY BUTTON STYLE (Submit) */
        #contactEditForm button[type="submit"] { 
            background-color: #4d2822; 
            color: #fff9ee; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 5px; 
        }
        
        /* SECONDARY BUTTON STYLE (Cancel / Hide Form) */
        #contactEditForm button[type="button"] { 
            background-color: #FFF9EE;
            color: #4d2822;
            padding: 10px 20px; 
            border: 1px solid #4d2822;
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 5px; 
            margin-left: 10px; 
        }
        
        /* ADD BUTTON style */
        .add-btn-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto 30px auto;
            padding: 0 20px;
        }
        .action-btn { 
            background-color: #8b3a3a; 
            color: #fff9ee; 
            padding: 10px 20px;
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
        }
        
        /* EDIT BUTTON on card style */
        .edit-btn {
            background-color: #4d2822;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            flex-shrink: 0; /* Prevents button from shrinking */
        }
    </style>
</head>
<body>
    <header class="banner"> 
        <img src="Images\Home.png" alt="Go Home Icon" class="banner-icon" /> 
        <h1 class="banner-title">Society Connect </h1> 
        <a href="homepage.html">
            <img src="Images\Home.png" alt="Go Home Icon" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 75px; height: 75px;">
        </a>
    </header> 

    <div id="committeeActions" class="add-btn-container" style="display: none;">
        <button id="addNewContactBtn" class="action-btn">âž• Add New Contact</button>
    </div>
    
    <div id="contactFormContainer">
        <form id="contactEditForm">
            <h3 id="formTitle">Add New Contact</h3>
            <input type="hidden" id="contactId" name="id" value=""> 

            <label for="contactGroupInput">Group Name (e.g., Committee Members, Emergency Services):</label>
            <input type="text" id="contactGroupInput" name="contactGroup" required>
            
            <label for="contactRoleInput">Contact Detail (e.g., Secretary: Mrs. Deshmukh, Police Assistance):</label>
            <input type="text" id="contactRoleInput" name="contactRole" required>

            <label for="contactNumberInput">Contact Number:</label>
            <input type="text" id="contactNumberInput" name="contactNumber" required>

            <label for="sortOrderInput">Sort Order (Lower number appears first in the group):</label>
            <input type="number" id="sortOrderInput" name="sortOrder" value="999">
            
            <button type="submit">Submit Contact</button>
            <button type="button" onclick="hideForm()">Cancel / Hide Form</button>
        </form>
    </div>

    <section id="contactsContainer" class="contacts">
        <p id="loadingMessage" style="text-align: center;">Loading contacts...</p>
        </section>

    <script>
        // Global storage for fetched data and committee status
        window.contactsData = [];
        window.isCommittee = false;
        
        const formContainer = document.getElementById('contactFormContainer');
        const formTitle = document.getElementById('formTitle');
        const contactForm = document.getElementById('contactEditForm');
        const addNewContactBtn = document.getElementById('addNewContactBtn');
        const contactsContainer = document.getElementById('contactsContainer');
        const committeeActions = document.getElementById('committeeActions');

        // Function to show and scroll to the form
        function showForm() {
            formContainer.style.display = 'block';
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Function to hide the form
        function hideForm() {
            formContainer.style.display = 'none';
        }

        // Function to prepare the form for a NEW record
        function prepareForAdd() {
            contactForm.reset();
            document.getElementById('contactId').value = '';
            document.getElementById('sortOrderInput').value = '999';
            formTitle.textContent = 'Add New Contact';
            showForm();
        }

        // Function to prepare the form for an UPDATE record
        function handleEdit(id) {
            const contact = window.contactsData.find(c => c.id === id);
            
            if (!contact) {
                alert("Error: Contact data not found.");
                return;
            }

            // Set the hidden ID field (THIS IS THE KEY FOR UPDATING)
            document.getElementById('contactId').value = contact.id; 
            
            // Populate fields
            document.getElementById('contactGroupInput').value = contact.contactGroup;
            document.getElementById('contactRoleInput').value = contact.contactRole;
            document.getElementById('contactNumberInput').value = contact.contactNumber;
            document.getElementById('sortOrderInput').value = contact.sortOrder;
            
            formTitle.textContent = 'Edit Contact: ' + contact.contactRole;

            showForm();
        }


        // --- MAIN FETCH AND INITIALIZATION ---

        fetch("/api/contacts")
            .then(res => res.json())
            .then(data => {
                contactsContainer.innerHTML = ''; // Clear loading message

                if (data.status !== "success") {
                    contactsContainer.innerHTML = `<p style="color: red; text-align: center;">${data.message || "Failed to load contacts."}</p>`;
                    return;
                }

                window.contactsData = data.data || [];
                window.isCommittee = data.isCommittee;
                
                const contacts = window.contactsData;

                // Show committee-only elements
                if (window.isCommittee) {
                    committeeActions.style.display = "block";
                    addNewContactBtn.addEventListener('click', prepareForAdd);
                }

                if (contacts.length === 0) {
                     contactsContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No contacts posted yet.</p>';
                     return;
                }

                // Group contacts by contactGroup
                const groupedContacts = contacts.reduce((acc, contact) => {
                    const group = contact.contactGroup;
                    if (!acc[group]) {
                        acc[group] = [];
                    }
                    acc[group].push(contact);
                    return acc;
                }, {});

                // Render the groups
                for (const groupName in groupedContacts) {
                    const groupDiv = document.createElement("div");
                    groupDiv.classList.add("contact-group");
                    
                    groupDiv.innerHTML = `<h2>${groupName}</h2><ul></ul>`;
                    const ul = groupDiv.querySelector('ul');

                    groupedContacts[groupName].forEach(c => {
                        let editButton = window.isCommittee 
                            ? `<button class="edit-btn" onclick="handleEdit(${c.id})">Edit</button>` 
                            : '';
                        
                        const li = document.createElement("li");
                        li.classList.add("contact-list-item");
                        
                        // NOTE: Changes applied here to use the new CSS classes for alignment
                        li.innerHTML = `
                            <span class="contact-role-text"><strong>ðŸ“ž ${c.contactRole}:</strong></span>
                            <span class="contact-number">${c.contactNumber}</span>
                            ${editButton}
                        `;
                        ul.appendChild(li);
                    });

                    contactsContainer.appendChild(groupDiv);
                }

            })
            .catch(err => {
                console.error("Contacts fetch failed:", err);
                contactsContainer.innerHTML = '<p style="color: red; padding: 20px; text-align: center;">Server error while loading contacts.</p>';
            });


        // --- FORM SUBMISSION HANDLER ---

        contactForm.addEventListener("submit", function(e) {
            e.preventDefault();

            if (!window.isCommittee) {
                alert("Access denied. You do not have permission to modify data.");
                return;
            }

            const contactIdValue = document.getElementById('contactId').value;
            const sortOrderValue = document.getElementById('sortOrderInput').value;
            
            // Safely determine the ID.
            const idToSend = (contactIdValue && !isNaN(parseInt(contactIdValue))) ? parseInt(contactIdValue) : null;
            
            // Gather form data
            const payload = {
                id: idToSend, // Crucial for backend UPDATE/CREATE decision
                contactGroup: document.getElementById('contactGroupInput').value.trim(),
                contactRole: document.getElementById('contactRoleInput').value.trim(),
                contactNumber: document.getElementById('contactNumberInput').value.trim(),
                sortOrder: parseInt(sortOrderValue) || 999
            };

            fetch("/api/contacts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || "Operation completed.");
                if (data.status === "success") {
                    location.reload(); // Refresh the page
                }
            })
            .catch(err => {
                console.error("Contact submission failed:", err);
                alert("Server error while submitting contact.");
            });
        });
    </script>
</body>
</html>