<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Raised Queries - SocietySync</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #FFF0D3, #FFF9EE); min-height: 100vh; }
        .banner { background-color: #4d2822; color: #FFF9EE; padding: 20px; text-align: center; position: relative; width: 100%; box-sizing: border-box; margin-bottom: 50px; }
        .banner-title { font-size: 28px; font-weight: bold; }
        .back-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); width: 75px; height: 75px; }
        .query-container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
        .query-card { background-color: #FFF9EE; padding: 20px; border-left: 5px solid #8b3a3a; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 25px; }
        .query-card h3 { color: #4d2822; margin-bottom: 10px; font-size: 20px; }
        .query-meta { font-size: 13px; color: #666; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .query-description { margin-top: 10px; color: #444; line-height: 1.5; }
        
        /* Committee Section Styles */
        .committee-actions { margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .answer-btn { background-color: #2E8B57; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        .answer-btn:hover { background-color: #246b45; }
        
        /* Answer Form */
        .answer-form { margin-top: 15px; padding: 15px; background: #fdfaf5; border: 1px solid #ddd; border-radius: 5px; }
        .answer-form h4 { margin-bottom: 10px; color: #4d2822; }
        .answer-form textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; resize: vertical; }
        .answer-form input[type="text"] { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .submit-answer-btn { padding: 8px 15px; background-color: #4d2822; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .cancel-answer-btn { padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <header class="banner">
        <h1>Quick Resolve </h1>
        <p>Already Raised Queries (Waiting for Resolution)</p>
        <a href="quickResolve.html">
        <img src="Images/Back to qR.png" alt="Back to Quick Resolve" class="back-icon">
        </a>
    </header> 
    
    <div id="queryList" class="query-container">
        <p style="text-align: center; color: #4d2822;">Loading raised queries...</p>
    </div>
    
    <template id="answerFormTemplate">
        <div class="answer-form" data-query-id="">
            <h4>Solution:</h4>
            <textarea class="answer-text" placeholder="Type proposed answer for query resolution here..." rows="4" required></textarea>
            <button type="button" class="submit-answer-btn">Submit Answer</button>
            <button type="button" class="cancel-answer-btn">Cancel</button>
            <div class="form-message" style="margin-top: 10px; font-size: 14px;"></div>
        </div>
    </template>

    <script defer>
        // MOCK FLAG: Use actual session/authentication check in production
        const IS_COMMITTEE_MEMBER = true; 
        
        const queryListDiv = document.getElementById('queryList');
        const answerFormTemplate = document.getElementById('answerFormTemplate');

        document.addEventListener('DOMContentLoaded', fetchRaisedQueries);

        async function fetchRaisedQueries() {
            queryListDiv.innerHTML = '<p style="text-align: center; color: #4d2822; padding: 30px;">Loading raised queries...</p>';

            try {
                // IMPORTANT: Ensure your Spring Boot endpoint is correctly mapped to /api/quickresolve/raised
                const res = await fetch("/api/quickresolve/raised");
                const queries = await res.json();

                queryListDiv.innerHTML = ''; // Clear loading message

                if (queries.length === 0) {
                    queryListDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;"> No outstanding queries! The society is running smoothly.</p>';
                    return;
                }

                queries.forEach(query => {
                    const card = document.createElement('div');
                    card.classList.add('query-card');
                    card.setAttribute('data-id', query.id);

                    let committeeSection = '';
                    if (IS_COMMITTEE_MEMBER) {
                        committeeSection = `
                            <div class="committee-actions">
                                <button class="answer-btn" data-query-id="${query.id}">Resolve Query</button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <h3>${query.title} (ID: ${query.id})</h3>
                        <p class="query-meta">
                            Raised by: <strong>${query.residentName}</strong> | Flat: <strong>${query.residentFlatNo}</strong> | ${query.dateRaised}
                        </p>
                        <p class="query-description">${query.description}</p>
                        ${committeeSection}
                    `;
                    queryListDiv.appendChild(card);
                });
                
                // Attach event listeners after cards are rendered
                document.querySelectorAll('.answer-btn').forEach(button => {
                    button.addEventListener('click', () => showAnswerForm(button));
                });

            } catch (err) {
                console.error("Fetch raised queries failed:", err);
                queryListDiv.innerHTML = '<p style="text-align: center; color: red; padding: 30px;">Error loading queries. Check the server connection.</p>';
            }
        }
        
        function showAnswerForm(buttonElement) {
            const queryId = buttonElement.getAttribute('data-query-id');
            const card = buttonElement.closest('.query-card');
            
            // Prevent multiple forms
            if (card.querySelector('.answer-form')) return; 

            const formClone = document.importNode(answerFormTemplate.content, true).querySelector('.answer-form');
            
            // Set up event listeners
            formClone.setAttribute('data-query-id', queryId);
            formClone.querySelector('.submit-answer-btn').addEventListener('click', () => submitAnswer(queryId, formClone));
            formClone.querySelector('.cancel-answer-btn').addEventListener('click', () => hideAnswerForm(formClone, buttonElement));

            // Append the form and hide the original button
            card.appendChild(formClone);
            buttonElement.style.display = 'none'; 
        }
        
        function hideAnswerForm(formElement, buttonElement) {
            // Restore the original button and remove the form
            buttonElement.style.display = 'inline-block';
            formElement.remove();
        }

        async function submitAnswer(queryId, formElement) {
            const answerText = formElement.querySelector('.answer-text').value.trim();
            // REMOVED: const answeredBy = formElement.querySelector('.answered-by').value.trim(); 
            const submitButton = formElement.querySelector('.submit-answer-btn');
            const formMessage = formElement.querySelector('.form-message');

            // Simplified validation
            if (!answerText) { 
                formMessage.textContent = "Please fill in the answer text.";
                formMessage.style.color = 'red';
                return;
            }
            
            formMessage.textContent = 'Submitting...';
            formMessage.style.color = '#444';
            submitButton.disabled = true;
            submitButton.textContent = 'Processing...';

            const payload = {
                queryId: parseInt(queryId),
                committeeAnswer: answerText,
                // REMOVED: answeredBy: answeredBy 
            };

            try {
                // IMPORTANT: Ensure your Spring Boot endpoint is correctly mapped to /api/quickresolve/answer
                const res = await fetch("/api/quickresolve/answer", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                // Check for successful status code (200-299)
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ message: 'Server error occurred.' }));
                    throw new Error(errorData.message || 'Failed to resolve query.');
                }
                
                const data = await res.json();

                formMessage.textContent = `✅ Query resolved successfully!`;
                formMessage.style.color = '#2E8B57';
                
                // Reload the list after a delay to show the query has moved to 'Solved'
                setTimeout(fetchRaisedQueries, 1500); 
                
            } catch (err) {
                console.error("Answer submission failed:", err);
                formMessage.textContent = `❌ Error: ${err.message || 'Could not connect to server.'}`;
                formMessage.style.color = 'red';
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Answer';
            }
        }
    </script>
</body>
</html>